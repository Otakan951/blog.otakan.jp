---
title: おたちょんを支えるちょんたらかんたら
date: 2022-12-23 00:00:00
tags:
    - Advent Calendar
    - Server
---
この記事は[mstdn.maud .io Advent Calendar 2022](https://adventar.org/calendars/7364)の23日目の記事です。
昨日はぱらつりくんの[2022年まとめ](https://paltee.notion.site/2022-a4218b9141fe491288d43c0ab277c439)でした。
隠しきれないドスパラがにじみ出る2022年まとめで、非常に面白かったです。

<!-- more -->
こんにちは、**ぱらおたちょんほた**のかん(おた)です。

書くことが何も思い浮かばないので、今年はぱらおたちょんほたについて書きます。
2021年まで遡っているけど、前の[二](https://shihorich.hatenablog.jp/entry/2022/12/21/230000)[人](https://paltee.notion.site/2022-a4218b9141fe491288d43c0ab277c439)もやっているのでええやろ。

# おたちょん鯖の歴史
## 2021年8月30日 -始まり-
ひらちょんの[去年の記事](https://hinabita.com/2021/12/24/advent2021/#9)で触れられていますが、一番最初のおたちょん鯖は私が持っていたCloud at Costのリソースを使って建てられました。
サーバはCaCを使い、ドメインは既に持っていたotakan.jpを使うことでお財布に優しい運用をする計画でした。

当時の会話を見返してみると、第二の[ほたとどん](https://hinabita.com/2018/11/07/mastodon_build/)として生み出されていたっぽいです。こわいね。
{% asset_img hirachon1.jpg%}

CaCが提供するOSテンプレートには1癖も2癖もあるので、適当なOSテンプレートでサーバを構築した後に手動でOSをクリーンインストールする事前準備が必要です。

私は事前にサーバを建てていたものの、クリーンインストールするのを忘れていました…
{% asset_img hotaotachon1.jpg%}

こうして生み出されたおたちょん鯖は9月5日に連合を開始しました。
おたちょんの[マルコフ連鎖bot](https://hota.hirachon.otakan.jp/@mecha_otachon)が投稿の収集を始めたり、誰かにブーストされたりすると激重になることがありましたが、大きな問題はなくそこそこ使えていました。

## 2021年10月3日 -何も知らないかん-
元々おたちょん鯖の「管理者への連絡先」は何も設定されていない(example.comのアドレスだったかも)状態でした。
それが突然、朝おきたら「ガチャガチャきゅ〜と・ふぃぎゅ@メイト」が登録されていました。
どちらにせよ連絡できないじゃん。

Mastodonのメールアドレス判定がガバガバなことに気がついたほたちょんが設定したらしい。
{% asset_img hotakan.jpg%}

私はこのとき「ガチャガチャきゅ〜と・ふぃぎゅ@メイト」の元ネタすら知らない状態でしたが、なんとなく面白そうだったので今でも「ガチャガチャきゅ〜と・ふぃぎゅ@メイト」のままになっています。

## 2022年3月1日 -おたちょん鯖が死んだ-
ひらちょんからサーバーが死んでると連絡があり、確かめたら本当に死んでいました。
とは言ってもCaCのサーバが死ぬことはよくあるもので、大抵はFile Systemが壊れることが原因です。

予想は的中してFile Systemがread onlyになっていました。
{% asset_img readonly.jpg%}
もちろん対処法はあって、[この記事](/2018/03/21/cac-read-only/)の方法3を実施するだけです。
サクッと直しました。

## 2022年3月2日 -おたちょん鯖が死んだ ツー-
おたちょん鯖がまた死んだ
方法3で再蘇生に成功してDBと.env.producionのバックアップは取れましたが、画像の移動は間に合わず、サーバが完全に死んで蘇生もできなくなってしまいました。
CaCのサーバ寿命が半年であることが確認できましたね。

<iframe src="https://mstdn.maud.io/@Otakan951/107886451651747418/embed" class="mastodon-embed" style="max-width: 100%; border: 0" width="400" allowfullscreen="allowfullscreen"></iframe><script src="https://mstdn.maud.io/embed.js" async="async"></script>

流石にCaCでサーバを建て直す気にはならず、別の場所へサーバを移すことにしました。

移行先はひらちょんが契約してきてくれた[WebARENA Indigo](https://web.arena.ne.jp/indigo/)です。
選択に大した理由はなくて、国内にサーバがあって安価だからだったはず。


ちなみに取り出せなかった画像ですが、CaCのサポートに殴り込んだら5日後に直してくれたので後日サルベージできました。
私も週休5日制の会社に勤めたい。
{% asset_img gary.jpg%}

なお直った直後でもread onlyのエラーは出ていた模様…
{% asset_img otakan1.jpg%}

Indigoに移動させるのと合わせて、mastodonの改変も始めました。
[最初の改変](https://github.com/Otakan951/mastodon/blob/da4e54b556c692cb2aab580571cf74a166d8e2c4/public/favicon.ico)はfaviconの変更でした。

※これ以降でCaCを使う機会はなかったのですが、最近になってCaCが買い切り制を辞めるといい出しました。
今後は月額制になる上に、初回更新費で[$102請求](https://hota.hirachon.otakan.jp/@otakan/109501273684346151)してきました。誰が払うか。
このタイミングでIndigoへ移動しておいて正解やったね。

## 2022年4月 -おたちょん語-
mastodonのv3.0.5対応もあり、この頃からちゃんとgitを使うようになったはず。
これ以前もコミット作って最低限の管理はしていたものの、ソースは公開しておらず割りと適当な運用をしていました。

様々な単語がおたちょん語になったのもこのときでした
* フォロワー→おたかん
* フォロー→ひらちょん
* 投稿→ほた
* メディア→おたかん
* 投稿と返信→ひらちょん

ひらちょんが[こんな](https://github.com/Otakan951/mastodon/commit/2bf008ccb0b136abb8bb335402969c663565f81c)[感じ](https://github.com/Otakan951/mastodon/commit/fb96d0a9f70686478bc51a8127d4a02178902051)でやってくれました。嬉しいね

その後もMastodonバージョンアップの度におたちょん語が更新されたことにより、今では ぱらつりさんは私のほたをぱらつりに登録してくれるし、ユーザーは投稿時にちいかわになったりしています。
{% asset_img para.jpg%}

多分こんな感じ
* 投稿(投稿ボタン)→ほたおたちょんｯﾃｺﾄ
* お気に入り→ぱらつり
* 投稿と返信→ひらとちょん

## 2022年6月28日 -テスト環境つくった-
実はこれ以前まではおたちょん鯖のテスト環境がなく、直接本番環境を触ってMastodonの改変をやっていました。
おたちょん語対応も、ひらちょんがテスト無しで改変したのを取り込んで実際の表示を確認する‥を繰り返す感じでした。
Postgres9.6→14.0への更新もぶっつけ本番でやっていたってマジ？

数ヶ月も運用していると、「多分動くと思うからリリースしようぜ」を何度も繰り返す度胸は流石になくなり、ローカルにテスト環境を作りました。
ようやく最低限の運用管理ができるようになった気がします。
テストサーバの名前は… mstdn.chiikawa

<iframe src="https://hota.hirachon.otakan.jp/@otakan/108550122674221876/embed" class="mastodon-embed" style="max-width: 100%; border: 0" width="400" allowfullscreen="allowfullscreen"></iframe><script src="https://hota.hirachon.otakan.jp/embed.js" async="async"></script>

## 2022年9月24日 -さくらになった-
さくらクラウドに引っ越した。

Indigoでなにか障害が発生したわけではありませんが、画像のアップロード速度に少し不満がありました。調べた感じだと、CPU性能が低いためにエンコードに時間がかかっている模様。
また、Indigoのサーバーはストレージが80GBしかなく、将来的なストレージ運用に不安もありました。
すでにバックアップのために画像を複製するのがギリギリ可能なラインまで使っていたこともあり、より大きなストレージを持つサーバか、オブジェクトストレージの利用を考えていました。

さくらクラウドは似たような値段でストレージ200GBが選択可能な上に、多少はアップロード速度が早くなりそう‥とほたおたちょんで考えていたら、ひらちょんが契約してくれました。
短期間のうちに3回目のサーバ移行となると手慣れたもの…ということはなく、以前やった手順を既に忘れていた。🥲

## 今
Indigoに移行してからは一度も障害が発生しておらず、快適に使えています。やっぱりCaCなんて本番で使うべきではないですね。
管理のおたかん、契約のひらちょん、偉大なるほたと、バランスの取れた運営ができています。
今後もこの調子で、「もはやこれまで」だけにはならないように頑張っていきたいです。

# 相互監視社会💞
## 位置情報共有
おたちょんはGoogleマップを使って24時間無期限の位置情報共有をしていますが、これを始めたのは2021年9月8日のことでした。
もう1年以上やってるってマジ…？

[21年8月にあった名古屋旅行](https://hinabita.com/2021/12/24/advent2021/#hota8)のときにひらちょんから期間限定で位置情報を貰ったことに味をしめたおたかんが、ダメ元で無期限共有を提案したら快諾してくれました

位置情報監視なんて言われたりしますが、実はそこまで相手の位置情報を見ていなかったりします。

>「昨日、〇〇行ってたの見守ってくれてた？」
「え～～～～…知しらなーーい」
「ｴｰｰｰｰｯ」

みたいな感じで、監視というよりは見守りですね。

ちなみに最近はぱらつりくんも見守ってくれます。
{% asset_img paraotachon.jpg%}

## 温湿度監視
おたちょんは自室にSwitchBotの温湿度計を置いていて、常に室温と湿度を測っています。
計測結果はSwitchBotアプリ以外にもAPIを叩くことで取得可能なため、Google App Scriptで収集することにしました。
相手の生活環境を常に把握する事ができてお得。
結構いい感じに取れています。
{% asset_img gas1.jpg%}

## キッチン監視
おたかんがダメ元で、ひらちょんの家に[SwitchBotカメラ](https://www.switchbot.jp/products/switchbot-indoor-cam)の設置を提案したら快諾してくれました。
動体を検知すると自動的に写真を保存してくれるので、後からカメラの前を通ったひらちょんの様子を確認することができる上に、一方的に通話することもできる。とても便利。
でもリビングには設置してくれないよ。

<iframe src="https://hota.hirachon.otakan.jp/@hirachon/109541078792809291/embed" class="mastodon-embed" style="max-width: 100%; border: 0" width="400" allowfullscreen="allowfullscreen"></iframe><script src="https://hota.hirachon.otakan.jp/embed.js" async="async"></script>

防犯の他、ちょんクッキング上映に役立っています。

## ぱらつりくん監視
監視してほしそうな[プロフィール](https://mstdn.maud.io/@paralleltree)していたので、心拍数監視することにしました。
本人に伝えてもニコニコしてたのでヨシ！
温湿度監視システムを少し書き換えるだけだったので、とても楽に監視環境が構築できました。

監視結果をもとに以下の判定をしてくれるbotがおたちょん鯖で動いています
* 今エッチなことをしているか
* 今お風呂にはいっているか

監視を始めてもう半年になりますが、入浴判定はそこそこ当たってる感じです。

[昨日のアドベントカレンダー](https://paltee.notion.site/2022-a4218b9141fe491288d43c0ab277c439#390c00522b3240ff82bfc7d87a6a38df)で知ったのですが、ぱらつりくんが末代鯖に来た理由は死活監視を作ったことを伝えるためだったらしい。
やっぱり監視されたかったんだ…

## Fitbit監視
おたちょんがMi BandからPixel Watchに乗り換えたことで、元々Fitbitを使っていたぱらつりくんと歩数計共有ができるようになりました。

使い始めてから知ったのですが、Fitbitにはフレンドに歩数の計測結果を「応援」したり、「からかう」ことができます。
{% asset_img hirachon2.jpg%}
ぱらおたちょんの誰かが旅行をして歩数が爆上がりするたびに、「応援」や「からかう」が飛んできます。楽しいね。

# 最後に
おたちょんという謎の関係は、ほたやぱらつりくんを巻き込みながら(多分)3年目に突入しました。

おたちょん鯖でなにかある度にほたに助言を貰っていたので、おたちょん鯖を支えているのは何よりもほたの存在だったりします。ありがとう。

去年の[人間関係図](https://hinabita.com/2021/12/24/advent2021/#2021)を見ると、おたちょんとぱらつりくんの間に関係線がありませんでした。
たった1年でぱらおたちょんという謎関係が出来上がるとは…何が起きるかわからないものやね。
{% asset_img paraotachonhota.jpg%}

明日の担当はひらちょんです。去年のタイトルが「ほたちょんまとめ(おたかんもいるよ)」だったということは…今年はきっと「ほたおたちょんまとめ(ぱらもいるよ)」ですね！